const axios = require('axios');
const cheerio = require('cheerio');

async function detectSoftware(url) {
  const detected = {
    webServer: null,
    backend: [],
    cms: null,
    frameworks: [],
    libraries: [],
    technologies: [],
    vulnerableComponents: []
  };

  try {
    const response = await axios.get(url, {
      maxRedirects: 5,
      timeout: 15000,
      validateStatus: () => true,
      headers: {
        'User-Agent': 'SecurityScanner/1.0'
      }
    });

    const headers = response.headers;
    
    // Header Analysis
    if (headers['server']) {
      detected.webServer = parseServerHeader(headers['server']);
    }

    if (headers['x-powered-by']) {
      const backend = parseBackend(headers['x-powered-by']);
      detected.backend.push(backend);
    }

    if (headers['x-generator']) {
      detected.cms = headers['x-generator'];
    }

    Object.keys(headers).forEach(header => {
      const lowerHeader = header.toLowerCase();
      
      if (lowerHeader.includes('x-drupal')) {
        detected.cms = 'Drupal';
      }
      if (lowerHeader.includes('x-wordpress')) {
        detected.cms = 'WordPress';
      }
      if (lowerHeader.includes('x-aspnet-version')) {
        detected.frameworks.push({
          name: 'ASP.NET',
          version: headers[header]
        });
      }
      if (lowerHeader === 'x-django-version') {
        detected.frameworks.push({
          name: 'Django',
          version: headers[header]
        });
      }
    });

    // HTML Analysis
    const htmlAnalysis = await analyzeHTML(response.data, url);
    
    if (htmlAnalysis.cms && !detected.cms) {
      detected.cms = htmlAnalysis.cms;
    }
    detected.frameworks.push(...htmlAnalysis.frameworks);
    detected.libraries.push(...htmlAnalysis.libraries);
    detected.technologies.push(...htmlAnalysis.technologies);
    detected.vulnerableComponents.push(...htmlAnalysis.vulnerableComponents);

    return detected;

  } catch (error) {
    console.error('Software detection failed:', error.message);
    return detected;
  }
}

function parseServerHeader(serverHeader) {
  const match = serverHeader.match(/^([^\/\s]+)\/?([\d\.]+)?/);
  
  if (match) {
    return {
      name: match[1],
      version: match[2] || 'unknown',
      raw: serverHeader
    };
  }
  
  return {
    name: serverHeader,
    version: 'unknown',
    raw: serverHeader
  };
}

function parseBackend(poweredBy) {
  const match = poweredBy.match(/^([^\/\s]+)\/?([\d\.]+)?/);
  
  if (match) {
    return {
      name: match[1],
      version: match[2] || 'unknown',
      raw: poweredBy
    };
  }
  
  return {
    name: poweredBy,
    version: 'unknown',
    raw: poweredBy
  };
}

async function analyzeHTML(html, url) {
  const $ = cheerio.load(html);
  const analysis = {
    cms: null,
    frameworks: [],
    libraries: [],
    technologies: [],
    vulnerableComponents: []
  };

  // WordPress
  if ($('link[href*="wp-content"]').length > 0 || 
      $('link[href*="wp-includes"]').length > 0 ||
      $('meta[name="generator"][content*="WordPress"]').length > 0) {
    
    const wpVersion = $('meta[name="generator"]').attr('content')?.match(/WordPress\s([\d\.]+)/)?.[1];
    analysis.cms = {
      name: 'WordPress',
      version: wpVersion || 'unknown'
    };
    
    if (wpVersion && isVulnerableWordPress(wpVersion)) {
      analysis.vulnerableComponents.push({
        name: 'WordPress',
        version: wpVersion,
        issue: 'Outdated WordPress version with known vulnerabilities'
      });
    }
  }

  // Drupal
  if ($('meta[name="Generator"][content*="Drupal"]').length > 0 ||
      $('script[src*="drupal"]').length > 0) {
    analysis.cms = { name: 'Drupal', version: 'unknown' };
  }

  // Joomla
  if ($('meta[name="generator"][content*="Joomla"]').length > 0 ||
      html.includes('/media/jui/')) {
    analysis.cms = { name: 'Joomla', version: 'unknown' };
  }

  // React
  if ($('div[id="root"]').length > 0 || 
      $('div[id="app"]').length > 0 ||
      html.includes('react') || 
      html.includes('React')) {
    analysis.frameworks.push({ name: 'React', type: 'Frontend Framework' });
  }

  // Vue.js
  if (html.includes('Vue') || $('[v-app]').length > 0) {
    analysis.frameworks.push({ name: 'Vue.js', type: 'Frontend Framework' });
  }

  // Angular
  if (html.includes('ng-app') || html.includes('ng-version')) {
    const ngVersion = html.match(/ng-version="([^"]+)"/)?.[1];
    analysis.frameworks.push({ 
      name: 'Angular', 
      version: ngVersion,
      type: 'Frontend Framework' 
    });
  }

  // Next.js
  if ($('script[src*="/_next/"]').length > 0 || html.includes('__NEXT_DATA__')) {
    analysis.frameworks.push({ name: 'Next.js', type: 'Frontend Framework' });
  }

  // jQuery
  const jqueryScripts = $('script[src*="jquery"]');
  if (jqueryScripts.length > 0) {
    jqueryScripts.each((i, elem) => {
      const src = $(elem).attr('src');
      const version = src?.match(/jquery[-.]?([\d\.]+)/)?.[1];
      analysis.libraries.push({ 
        name: 'jQuery', 
        version: version || 'unknown',
        type: 'Library' 
      });
      
      if (version && isVulnerableJQuery(version)) {
        analysis.vulnerableComponents.push({
          name: 'jQuery',
          version: version,
          issue: 'Vulnerable jQuery version detected'
        });
      }
    });
  }

  // Bootstrap
  if ($('link[href*="bootstrap"]').length > 0) {
    const bootstrapLink = $('link[href*="bootstrap"]').attr('href');
    const version = bootstrapLink?.match(/bootstrap[\/@]([\d\.]+)/)?.[1];
    analysis.libraries.push({ 
      name: 'Bootstrap', 
      version: version || 'unknown',
      type: 'CSS Framework' 
    });
  }

  // Google Analytics
  if (html.includes('google-analytics.com') || html.includes('gtag')) {
    analysis.technologies.push({ name: 'Google Analytics', type: 'Analytics' });
  }

  // Google Tag Manager
  if (html.includes('googletagmanager.com')) {
    analysis.technologies.push({ name: 'Google Tag Manager', type: 'Tag Manager' });
  }

  return analysis;
}

function isVulnerableWordPress(version) {
  const versionNum = parseFloat(version);
  return versionNum < 6.0;
}

function isVulnerableJQuery(version) {
  const versionNum = parseFloat(version);
  return versionNum < 3.5;
}

module.exports = { detectSoftware };
